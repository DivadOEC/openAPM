<map version="0.9.0">
<!-- To view this file, download free mind mapping software FreeMind from http://freemind.sourceforge.net -->
<node CREATED="1367374756452" ID="ID_495163599" MODIFIED="1367377775142" TEXT="openAPM&#x7c7b;&#x7ed3;&#x6784;&#x89e3;&#x6790;">
<node CREATED="1367374801111" ID="ID_1003899353" MODIFIED="1367375154055" POSITION="right" TEXT="&#x547d;&#x540d;&#x7a7a;&#x95f4;">
<font NAME="SansSerif" SIZE="12"/>
</node>
<node CREATED="1367375303250" ID="ID_1650210515" MODIFIED="1367375373884" POSITION="right" TEXT="&#x4ee3;&#x7801;&#x4e2d;&#x6240;&#x6709;AP_HAL&#x5b57;&#x6bb5;&#x90fd;&#x662f;&#x5728;&#x6307;&#x660e;&#x547d;&#x540d;&#x7a7a;&#x95f4;&#xff0c;&#x53ef;&#x4ee5;&#x628a;&#x5b83;&#x900f;&#x660e;&#x6389;"/>
<node CREATED="1367375175131" ID="ID_141681030" MODIFIED="1367377757964" POSITION="right" TEXT="namespace AP_HAL {&#xa;    /* Toplevel pure virtual class Hal.*/&#xa;    class HAL;&#xa;&#xa;    /* Toplevel class names for drivers: */&#xa;    class UARTDriver;&#xa;    class I2CDriver;&#xa;&#xa;    class SPIDeviceDriver;&#xa;    class SPIDeviceManager;&#xa;&#xa;    class AnalogSource;&#xa;    class AnalogIn;&#xa;    class Storage;&#xa;    class ConsoleDriver;&#xa;    class DigitalSource;&#xa;    class GPIO;&#xa;    class RCInput;&#xa;    class RCOutput;&#xa;    class Scheduler;&#xa;    class Semaphore;&#xa;    &#xa;    class Util;&#xa;&#xa;    /* Utility Classes */&#xa;    class Print;&#xa;    class Stream;&#xa;    class BetterStream;&#xa;&#xa;    /* Typdefs for function pointers (Procedure, Timed Procedure) */&#xa;    typedef void(*Proc)(void);&#xa;    typedef void(*TimedProc)(uint32_t);&#xa;&#xa;    /**&#xa;     * Global names for all of the existing SPI devices on all platforms.&#xa;     */&#xa;&#xa;    enum SPIDevice {&#xa;        SPIDevice_Dataflash,&#xa;        SPIDevice_ADS7844,&#xa;        SPIDevice_MS5611,&#xa;        SPIDevice_MPU6000,&#xa;        SPIDevice_ADNS3080_SPI0,&#xa;        SPIDevice_ADNS3080_SPI3&#xa;    };&#xa;}">
<font NAME="SansSerif" SIZE="12"/>
</node>
<node CREATED="1367375569949" ID="ID_1599706013" MODIFIED="1367375687953" POSITION="right" TEXT="&#x5173;&#x6ce8;&#x9876;&#x5c42;&#x57fa;&#x7c7b; HAL&#xff0c;&#x8be5;&#x7c7b;&#x7684;&#x6784;&#x9020;&#x51fd;&#x6570;&#x4e2d;&#x58f0;&#x660e;&#x4e86;&#x6240;&#x6709;&#x5728;&#x547d;&#x540d;&#x7a7a;&#x95f4;&#x4e2d;&#x4f53;&#x73b0;&#x4e86;&#x7684;&#x7c7b;&#x7684;&#x5bf9;&#x8c61;&#xff0c;&#x5e76;&#x8c03;&#x7528;&#x4e86;&#x4ed6;&#x4eec;&#x7684;&#x6784;&#x9020;&#x51fd;&#x6570;"/>
<node CREATED="1367375698873" ID="ID_1258065493" MODIFIED="1367376021833" POSITION="right" TEXT="class AP_HAL::HAL {&#xa;public:&#xa;    HAL(AP_HAL::UARTDriver* _uartA,&#xa;        AP_HAL::UARTDriver* _uartB,&#xa;        AP_HAL::UARTDriver* _uartC,&#xa;        AP_HAL::I2CDriver*  _i2c,&#xa;        AP_HAL::SPIDeviceManager* _spi,&#xa;        AP_HAL::AnalogIn*   _analogin,&#xa;        AP_HAL::Storage*    _storage,&#xa;        AP_HAL::ConsoleDriver* _console,&#xa;        AP_HAL::GPIO*       _gpio,&#xa;        AP_HAL::RCInput*    _rcin,&#xa;        AP_HAL::RCOutput*   _rcout,&#xa;        AP_HAL::Scheduler*  _scheduler,&#xa;        AP_HAL::Util*       _util)&#xa;        :&#xa;        uartA(_uartA),&#xa;        uartB(_uartB),&#xa;        uartC(_uartC),&#xa;        i2c(_i2c),&#xa;        spi(_spi),&#xa;        analogin(_analogin),&#xa;        storage(_storage),&#xa;        console(_console),&#xa;        gpio(_gpio),&#xa;        rcin(_rcin),&#xa;        rcout(_rcout),&#xa;        scheduler(_scheduler),&#xa;        util(_util)&#xa;    {}&#xa;&#xa;    virtual void init(int argc, char * const argv[]) const = 0;&#xa;&#xa;    AP_HAL::UARTDriver* uartA;&#xa;    AP_HAL::UARTDriver* uartB;&#xa;    AP_HAL::UARTDriver* uartC;&#xa;    AP_HAL::I2CDriver*  i2c;&#xa;    AP_HAL::SPIDeviceManager* spi;&#xa;    AP_HAL::AnalogIn*   analogin;&#xa;    AP_HAL::Storage*    storage;&#xa;    AP_HAL::ConsoleDriver* console;&#xa;    AP_HAL::GPIO*       gpio;&#xa;    AP_HAL::RCInput*    rcin;&#xa;    AP_HAL::RCOutput*   rcout;&#xa;    AP_HAL::Scheduler*  scheduler;&#xa;    AP_HAL::Util*       util;&#xa;};"/>
<node CREATED="1367377564472" ID="ID_1324268238" MODIFIED="1367377590835" POSITION="right" TEXT="&#x8fd9;&#x4e2a;&#x57fa;&#x7c7b;&#x662f;&#x6ca1;&#x6709;&#x4f53;&#x73b0;&#x786c;&#x4ef6;&#x5e73;&#x53f0;&#x7684;&#xff0c;&#x6240;&#x6709;&#x5f53;&#x4f7f;&#x7528;AVR&#x7684;&#x65f6;&#x5019;&#xff0c;&#x5176;&#x5b9e;&#x8fd8;&#x4f1a;&#x53bb;&#x6784;&#x9020;&#x4e00;&#x4e9b;&#x6240;&#x8c13;&#x7684;AP_HAL_AVR&#x7684;&#x7c7b;&#xff0c;&#x53ef;&#x4ee5;&#x770b;&#x4e00;&#x4e0b;&#x5b83;&#x7684;&#x547d;&#x540d;&#x7a7a;&#x95f4;"/>
<node CREATED="1367377864759" ID="ID_630490676" MODIFIED="1367378089234" POSITION="right" TEXT="  namespace AP_HAL_AVR {&#xa;      class HAL_AVR;&#xa;  &#xa;      class AVRUARTDriver;&#xa;      class AVRI2CDriver;&#xa;      class APM1SPIDeviceManager;&#xa;      class APM2SPIDeviceManager;&#xa;      class AVRSPI0DeviceDriver;&#xa;      class AVRSPI2DeviceDriver;&#xa;      class AVRSPI3DeviceDriver;&#xa;      class ADCSource;&#xa;      class AVRAnalogIn;&#xa;      class AVREEPROMStorage;&#xa;      class AVRConsoleDriver;&#xa;      class AVRGPIO;&#xa;      class AVRDigitalSource;&#xa;      class APM1RCInput;&#xa;      class APM2RCInput;&#xa;      class APM1RCOutput;&#xa;      class APM2RCOutput; &#xa;      class AVRScheduler; &#xa;      class AVRTimer;&#xa;      class AVRSemaphore; &#xa;      class ISRRegistry;&#xa;      class AVRUtil;&#xa;  }&#xa;"/>
<node CREATED="1367376504136" ID="ID_1770182152" MODIFIED="1367376537332" POSITION="left" TEXT="&#x8ffd;&#x8e2a;HAL&#x57fa;&#x7c7b;&#x7684;&#x5b9e;&#x4f8b;"/>
<node CREATED="1367376539271" ID="ID_1386504960" MODIFIED="1367376598058" POSITION="left" TEXT="&#x4e3b;&#x6587;&#x4ef6;&#x4e2d;&#x8c03;&#x7528;&#xff1a;const AP_HAL::HAL&amp; hal = AP_HAL_BOARD_DRIVER;"/>
<node CREATED="1367376640166" ID="ID_1164107445" MODIFIED="1367376681168" POSITION="left" TEXT="&#x770b;&#x770b;AP_HAL_BOARD_DRIVER&#x7684;&#x5185;&#x5bb9;;"/>
<node CREATED="1367376683347" ID="ID_1499632572" MODIFIED="1367376847943" POSITION="left" TEXT="/*&#x6839;&#x636e;&#x914d;&#x7f6e;&#xff0c;&#x9009;&#x62e9;&#x786c;&#x4ef6;&#xff0c;&#x5176;&#x5b9e;&#x662f;&#x9009;&#x62e9;HAL&#x7c7b;&#x7684;&#x5b9e;&#x4f8b;&#x5185;&#x5bb9;&#x548c;&#x5b9e;&#x73b0;&#x65b9;&#x5f0f;*/ &#xa;#if CONFIG_HAL_BOARD == HAL_BOARD_APM1&#xa; #define AP_HAL_BOARD_DRIVER AP_HAL_AVR_APM1&#xa; #elif CONFIG_HAL_BOARD == HAL_BOARD_APM2&#xa; #define AP_HAL_BOARD_DRIVER AP_HAL_AVR_APM2&#xa; #elif CONFIG_HAL_BOARD == HAL_BOARD_AVR_SITL&#xa; #define AP_HAL_BOARD_DRIVER AP_HAL_AVR_SITL&#xa; #elif CONFIG_HAL_BOARD == HAL_BOARD_PX4&#xa; #define AP_HAL_BOARD_DRIVER AP_HAL_PX4&#xa; #elif CONFIG_HAL_BOARD == HAL_BOARD_SMACCM&#xa; #define AP_HAL_BOARD_DRIVER AP_HAL_SMACCM&#xa; #elif CONFIG_HAL_BOARD == HAL_BOARD_EMPTY&#xa; #define AP_HAL_BOARD_DRIVER AP_HAL_Empty&#xa; #else&#xa; #error &quot;Unknown CONFIG_HAL_BOARD type&quot;&#xa; #endif&#xa;"/>
<node CREATED="1367378605824" ID="ID_1711455189" MODIFIED="1367378827779" POSITION="left" TEXT="AVR&#x786c;&#x4ef6;&#x67b6;&#x6784;&#x7684;&#x5b9e;&#x4f8b;&#x58f0;&#x660e;&#x4e4b;&#x540e;&#xff0c;&#x4f20;&#x9012;&#x7ed9;HAL&#x7684;&#x5b9e;&#x73b0;,&#x7b80;&#x5355;&#x7684;&#x8bf4;&#xff0c;&#x5c31;&#x662f;HAL_AVR_APM2&#x7ee7;&#x627f;HAL&#xff0c;&#x7136;&#x540e;&#x6784;&#x9020;&#x4e86;&#x4e00;&#x4e2a;&#x5b9e;&#x4f8b;"/>
<node CREATED="1367377783831" ID="ID_112944591" MODIFIED="1367378600586" POSITION="left" TEXT="static AVRSemaphore     i2cSemaphore;&#xa;static AVRI2CDriver     avrI2CDriver(&amp;i2cSemaphore);&#xa;static APM2SPIDeviceManager apm2SPIDriver;&#xa;static AVRAnalogIn      avrAnalogIn;&#xa;static AVREEPROMStorage avrEEPROMStorage;&#xa;static AVRConsoleDriver consoleDriver;&#xa;static AVRGPIO          avrGPIO;&#xa;static APM2RCInput      apm2RCInput;&#xa;static APM2RCOutput     apm2RCOutput;&#xa;static AVRScheduler     avrScheduler;&#xa;static AVRUtil          avrUtil;&#xa;&#xa;static ISRRegistry isrRegistry;&#xa;&#xa;HAL_AVR_APM2::HAL_AVR_APM2() :&#xa;    AP_HAL::HAL(&#xa;        &amp;avrUart0Driver, /* phys UART0 -&gt; uartA */&#xa;        &amp;avrUart1Driver, /* phys UART1 -&gt; uartB */&#xa;        &amp;avrUart2Driver, /* phys UART2 -&gt; uartC */&#xa;        &amp;avrI2CDriver,&#xa;        &amp;apm2SPIDriver,&#xa;        &amp;avrAnalogIn,&#xa;        &amp;avrEEPROMStorage,&#xa;        &amp;consoleDriver,&#xa;        &amp;avrGPIO,&#xa;        &amp;apm2RCInput,&#xa;        &amp;apm2RCOutput,&#xa;        &amp;avrScheduler,&#xa;        &amp;avrUtil )&#xa;{}&#xa;&#xa;void HAL_AVR_APM2::init(int argc, char * const argv[]) const {&#xa;&#xa;    scheduler-&gt;init((void*)&amp;isrRegistry);&#xa;   &#xa;    /* uartA is the serial port used for the console, so lets make sure&#xa;     * it is initialized at boot */&#xa;    uartA-&gt;begin(115200);&#xa;    console-&gt;init((void*)uartA);&#xa;    /* The AVR RCInput drivers take an AP_HAL_AVR::ISRRegistry*&#xa;     * as the init argument */&#xa;    rcin-&gt;init((void*)&amp;isrRegistry);&#xa;    rcout-&gt;init(NULL);&#xa;    spi-&gt;init(NULL);&#xa;    i2c-&gt;begin();&#xa;    i2c-&gt;setTimeout(100);&#xa;    analogin-&gt;init(NULL);&#xa;&#xa;    /* Enable the pullups on the RX pins of the 3 UARTs This is important when&#xa;     * the RX line is high-Z: capacitive coupling between input and output pins&#xa;     * can cause bytes written to show up as an input. Occasionally this causes&#xa;     * us to detect a phantom GPS by seeing our own outgoing config message.&#xa;     * PE0 : RX0 (uartA)&#xa;     * PD2 : RX1 (uartB)&#xa;     * PH0 : RX2 (uartC)&#xa;     */&#xa;&#xa;    PORTE |= _BV(0);&#xa;    PORTD |= _BV(2);&#xa;    PORTH |= _BV(0);&#xa;};&#xa;&#xa;const HAL_AVR_APM2 AP_HAL_AVR_APM2;"/>
<node CREATED="1367378929085" ID="ID_1007251101" MODIFIED="1367378990080" POSITION="left" TEXT="&#x4e0a;&#x9762;&#x7c7b;&#x4e2d;&#x6709;init&#x65b9;&#x6cd5;&#xff0c;&#x8fd9;&#x4e2a;&#x65b9;&#x6cd5;&#x4e2d;&#x8c03;&#x7528;&#x4e86;&#x4e00;&#x4e9b;&#x6a21;&#x5757;&#x7684;&#x521d;&#x59cb;&#x5316;&#x65b9;&#x6cd5;"/>
<node CREATED="1367379052792" ID="ID_1705511923" MODIFIED="1367379079568" POSITION="left" TEXT="&#x5177;&#x4f53;&#x7684;&#x5c31;&#x53ef;&#x4ee5;&#x6df1;&#x5165;&#x5230;&#x6bcf;&#x4e2a;&#x6a21;&#x5757;&#x7684;&#x7c7b;&#x7684;&#x6784;&#x9020;&#x4e2d;&#x53bb;&#x4e86;&#x3002;"/>
</node>
</map>
